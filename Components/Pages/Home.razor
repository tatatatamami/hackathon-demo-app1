@page "/"
@rendermode InteractiveServer
@using ChatApp.Models
@using ChatApp.Services
@inject ScenarioRepository ScenarioRepository
@inject ReplyEngine ReplyEngine
@inject IJSRuntime JSRuntime

<PageTitle>Chat UI - Hackathon Demo</PageTitle>

<div class="chat-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="agent-list">
            @foreach (var agent in _agents)
            {
                <div class="agent-item @(agent == _selectedAgent ? "selected" : "")" 
                     @onclick="() => SelectAgent(agent)">
                    <div class="agent-avatar">
                        @if (TryGetAgentIconUrl(agent, out var iconUrl))
                        {
                            <img class="agent-avatar-img" src="@iconUrl" alt="@agent" />
                        }
                        else
                        {
                            @DefaultAgentEmoji
                        }
                    </div>
                    <div class="agent-name">@agent</div>
                </div>
            }
        </div>
        <div class="user-info">
            <div class="user-avatar">👤</div>
            <div class="user-name">Tamami</div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-area">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-content">
                <div class="agent-avatar-small">
                    @if (TryGetAgentIconUrl(_selectedAgent, out var headerIconUrl))
                    {
                        <img class="agent-avatar-img" src="@headerIconUrl" alt="@_selectedAgent" />
                    }
                    else
                    {
                        @DefaultAgentEmoji
                    }
                </div>
                <div class="header-info">
                    <div class="header-agent-name">@_selectedAgent</div>
                    <div class="header-status">● Online</div>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" @ref="_chatMessagesDiv">
            @if (_selectedAgent == PrimaryAgentName)
            {
                @foreach (var message in _messages)
                {
                    <div class="message-wrapper @(message.Role == "User" ? "user-message" : "agent-message")">
                        @if (message.Role == "Agent")
                        {
                            <div class="agent-label">@message.AgentName</div>
                        }
                        <div class="message-bubble">
                            <div class="message-text">@message.Text</div>
                            @* Legacy single collapsed section support *@
                            @if (!string.IsNullOrWhiteSpace(message.CollapsedText))
                            {
                                <details class="agent-details">
                                    <summary>@(message.CollapsedTitle ?? "詳細")</summary>
                                    <div class="agent-details-body">
                                        @message.CollapsedText
                                    </div>
                                </details>
                            }
                            @* New multiple collapsed sections support *@
                            @if (message.AgentReplyCollapsedSections != null && message.AgentReplyCollapsedSections.Count > 0)
                            {
                                @foreach (var collapsedSection in message.AgentReplyCollapsedSections)
                                {
                                    <details class="agent-details">
                                        <summary>@collapsedSection.Title</summary>
                                        <div class="agent-details-body">
                                            @collapsedSection.Body
                                        </div>
                                    </details>
                                }
                            }
                            @if (!string.IsNullOrEmpty(message.ImageDataUrl))
                            {
                                <div class="message-image" @onclick="() => ShowImageModal(message.ImageDataUrl)">
                                    <img src="@message.ImageDataUrl" alt="Attached image" />
                                </div>
                            }
                            <div class="message-time">@message.Timestamp.ToString("HH:mm")</div>
                        </div>
                    </div>
                }
                @if (_isTyping)
                {
                    <div class="message-wrapper agent-message">
                        <div class="agent-label">@_selectedAgent</div>
                        <div class="message-bubble typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="no-permission-message">
                    <div class="no-permission-icon">🔒</div>
                    <div class="no-permission-text">権限なし</div>
                    <div class="no-permission-subtext">このエージェントへのアクセス権限がありません。@PrimaryAgentName をご利用ください。</div>
                </div>
            }
        </div>

        <!-- Input Area -->
        <div class="chat-input-area">
            @if (_attachedImageDataUrl != null)
            {
                <div class="image-preview">
                    <img src="@_attachedImageDataUrl" alt="Preview" />
                    <button class="remove-image-btn" @onclick="RemoveAttachedImage">×</button>
                </div>
            }
            <div class="input-row">
                <textarea class="message-input" 
                          placeholder="メッセージを入力..." 
                          @bind="_inputMessage" 
                          @bind:event="oninput"
                          @onkeydown="HandleKeyDown"
                          rows="3"
                          disabled="@(_selectedAgent != PrimaryAgentName)"></textarea>
                <div class="input-buttons">
                    <label class="attach-button" title="画像を添付">
                        <InputFile OnChange="HandleImageSelected" accept="image/*" disabled="@(_selectedAgent != PrimaryAgentName)" />
                        📎
                    </label>
                    <button class="send-button" 
                            @onclick="SendMessage" 
                            disabled="@(_selectedAgent != PrimaryAgentName || (string.IsNullOrWhiteSpace(_inputMessage) && _attachedImageDataUrl == null))">
                        送信
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
@if (_modalImageUrl != null)
{
    <div class="modal-overlay" @onclick="CloseImageModal">
        <div class="modal-content" @onclick:stopPropagation>
            <button class="modal-close" @onclick="CloseImageModal">×</button>
            <img src="@_modalImageUrl" alt="Enlarged image" />
        </div>
    </div>
}

@code {
    private const int MaxFileSizeBytes = 5 * 1024 * 1024; // 5 MB

    private const string PrimaryAgentName = "Red Dragon Agent";
    private const string DefaultAgentEmoji = "🤖";

    // Put your prepared icon image under `wwwroot/images/` (recommended) and set the URL here.
    // Example: `wwwroot/images/red-dragon-agent.png` -> "/images/red-dragon-agent.png"
    private const string PrimaryAgentIconUrl = "/images/red-dragon-agent.png";

    private List<string> _agents = new() { PrimaryAgentName, "Game B Agent", "Game C Agent", "Game D Agent", "Game E Agent" };
    private string _selectedAgent = PrimaryAgentName;
    private List<ChatMessage> _messages = new();
    private string _inputMessage = string.Empty;
    private string? _attachedImageDataUrl;
    private string? _modalImageUrl;
    private bool _isTyping = false;
    private ElementReference _chatMessagesDiv;

    private static bool TryGetAgentIconUrl(string agentName, out string? iconUrl)
    {
        if (agentName == PrimaryAgentName)
        {
            iconUrl = PrimaryAgentIconUrl;
            return true;
        }

        iconUrl = null;
        return false;
    }

    protected override async Task OnInitializedAsync()
    {
        await ScenarioRepository.LoadScenariosAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_messages.Count > 0)
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", _chatMessagesDiv);
        }
    }

    private void SelectAgent(string agent)
    {
        _selectedAgent = agent;
        _messages.Clear();
        _inputMessage = string.Empty;
        _attachedImageDataUrl = null;
    }

    private async Task HandleImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        try
        {
            if (file.Size > MaxFileSizeBytes)
            {
                // Could show user-friendly error message here
                return;
            }

            var buffer = new byte[file.Size];
            using var stream = file.OpenReadStream(maxAllowedSize: MaxFileSizeBytes);
            await stream.ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            _attachedImageDataUrl = $"data:{file.ContentType};base64,{base64}";
        }
        catch (IOException)
        {
            // Handle file read errors silently for demo purposes
            _attachedImageDataUrl = null;
        }
    }

    private void RemoveAttachedImage()
    {
        _attachedImageDataUrl = null;
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_inputMessage) && _attachedImageDataUrl == null)
            return;

        // Add user message
        var userMessage = new ChatMessage
        {
            Role = "User",
            Text = _inputMessage,
            ImageDataUrl = _attachedImageDataUrl,
            Timestamp = DateTime.Now
        };
        _messages.Add(userMessage);

        var messageText = _inputMessage;
        var hasImage = _attachedImageDataUrl != null;

        // Clear input
        _inputMessage = string.Empty;
        _attachedImageDataUrl = null;

        // Show typing indicator
        _isTyping = true;
        StateHasChanged();

        // Get reply from engine
        var replyTurn = await ReplyEngine.GetReplyAsync(_selectedAgent, messageText, hasImage);

        // Hide typing indicator
        _isTyping = false;

        // Add agent message
        var agentMessage = new ChatMessage
        {
            Role = "Agent",
            Text = replyTurn?.AgentReply ?? "返信を取得できませんでした。",
            Timestamp = DateTime.Now,
            AgentName = _selectedAgent,
            CollapsedTitle = replyTurn?.AgentReplyCollapsedTitle,
            CollapsedText = replyTurn?.AgentReplyCollapsed,
            AgentReplyCollapsedSections = replyTurn?.AgentReplyCollapsedSections
        };
        _messages.Add(agentMessage);

        StateHasChanged();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private void ShowImageModal(string? imageUrl)
    {
        _modalImageUrl = imageUrl;
    }

    private void CloseImageModal()
    {
        _modalImageUrl = null;
    }
}
