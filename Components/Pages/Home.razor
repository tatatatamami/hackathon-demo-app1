@page "/"
@rendermode InteractiveServer
@using ChatApp.Models
@using ChatApp.Services
@using Microsoft.Extensions.Options
@inject ScenarioRepository ScenarioRepository
@inject ReplyEngine ReplyEngine
@inject IJSRuntime JSRuntime
@inject IOptions<CopilotStudioOptions> CopilotOptions

<PageTitle>Chat UI - Hackathon Demo</PageTitle>

<div class="chat-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="agent-list">
            @foreach (var agent in _agents)
            {
                <div class="agent-item @(agent == _selectedAgent ? "selected" : "")" 
                     @onclick="() => SelectAgent(agent)">
                    <div class="agent-avatar">🤖</div>
                    <div class="agent-name">@agent</div>
                </div>
            }
        </div>
        <div class="user-info">
            <div class="user-avatar">👤</div>
            <div class="user-name">Tamami</div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-area">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-content">
                <div class="agent-avatar-small">🤖</div>
                <div class="header-info">
                    <div class="header-agent-name">@_selectedAgent</div>
                    <div class="header-status">● Online</div>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" @ref="_chatMessagesDiv">
            @if (_selectedAgent == "Game A Agent")
            {
                <!-- Copilot Studio Webchat iframe for Game A Agent -->
                <div class="chat-frame-container">
                    @if (_isIframeLoading)
                    {
                        <div class="loading-indicator">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Loading webchat...</div>
                        </div>
                    }
                    <iframe 
                        src="@CopilotOptions.Value.GameAWebChatUrl"
                        class="chat-frame @(_isIframeLoading ? "hidden" : "")"
                        @onload="OnIframeLoaded"
                        title="Copilot Studio Webchat">
                    </iframe>
                </div>
            }
            else
            {
                <div class="no-permission-message">
                    <div class="no-permission-icon">🔒</div>
                    <div class="no-permission-text">権限なし</div>
                    <div class="no-permission-subtext">このエージェントへのアクセス権限がありません。Game A Agentをご利用ください。</div>
                </div>
            }
        </div>

        <!-- Input Area -->
        <div class="chat-input-area" style="@(_selectedAgent == "Game A Agent" ? "display: none;" : "")">
            @if (_attachedImageDataUrl != null)
            {
                <div class="image-preview">
                    <img src="@_attachedImageDataUrl" alt="Preview" />
                    <button class="remove-image-btn" @onclick="RemoveAttachedImage">×</button>
                </div>
            }
            <div class="input-row">
                <textarea class="message-input" 
                          placeholder="メッセージを入力..." 
                          @bind="_inputMessage" 
                          @bind:event="oninput"
                          @onkeydown="HandleKeyDown"
                          rows="3"
                          disabled="@(_selectedAgent != "Game A Agent")"></textarea>
                <div class="input-buttons">
                    <label class="attach-button" title="画像を添付">
                        <InputFile OnChange="HandleImageSelected" accept="image/*" disabled="@(_selectedAgent != "Game A Agent")" />
                        📎
                    </label>
                    <button class="send-button" 
                            @onclick="SendMessage" 
                            disabled="@(_selectedAgent != "Game A Agent" || (string.IsNullOrWhiteSpace(_inputMessage) && _attachedImageDataUrl == null))">
                        送信
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
@if (_modalImageUrl != null)
{
    <div class="modal-overlay" @onclick="CloseImageModal">
        <div class="modal-content" @onclick:stopPropagation>
            <button class="modal-close" @onclick="CloseImageModal">×</button>
            <img src="@_modalImageUrl" alt="Enlarged image" />
        </div>
    </div>
}

@code {
    private const int MaxFileSizeBytes = 5 * 1024 * 1024; // 5 MB
    
    private List<string> _agents = new() { "Game A Agent", "Game B Agent", "Game C Agent", "Game D Agent", "Game E Agent" };
    private string _selectedAgent = "Game A Agent";
    private List<ChatMessage> _messages = new();
    private string _inputMessage = string.Empty;
    private string? _attachedImageDataUrl;
    private string? _modalImageUrl;
    private bool _isTyping = false;
    private bool _isIframeLoading = true;
    private ElementReference _chatMessagesDiv;

    protected override async Task OnInitializedAsync()
    {
        await ScenarioRepository.LoadScenariosAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_messages.Count > 0)
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", _chatMessagesDiv);
        }
    }

    private void SelectAgent(string agent)
    {
        _selectedAgent = agent;
        _messages.Clear();
        _inputMessage = string.Empty;
        _attachedImageDataUrl = null;
        
        // Reset iframe loading state when switching to Game A Agent
        if (agent == "Game A Agent")
        {
            _isIframeLoading = true;
        }
    }
    
    private void OnIframeLoaded()
    {
        _isIframeLoading = false;
        StateHasChanged();
    }

    private async Task HandleImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        try
        {
            if (file.Size > MaxFileSizeBytes)
            {
                // Could show user-friendly error message here
                return;
            }

            var buffer = new byte[file.Size];
            using var stream = file.OpenReadStream(maxAllowedSize: MaxFileSizeBytes);
            await stream.ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            _attachedImageDataUrl = $"data:{file.ContentType};base64,{base64}";
        }
        catch (IOException)
        {
            // Handle file read errors silently for demo purposes
            _attachedImageDataUrl = null;
        }
    }

    private void RemoveAttachedImage()
    {
        _attachedImageDataUrl = null;
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_inputMessage) && _attachedImageDataUrl == null)
            return;

        // Add user message
        var userMessage = new ChatMessage
        {
            Role = "User",
            Text = _inputMessage,
            ImageDataUrl = _attachedImageDataUrl,
            Timestamp = DateTime.Now
        };
        _messages.Add(userMessage);

        var messageText = _inputMessage;
        var hasImage = _attachedImageDataUrl != null;

        // Clear input
        _inputMessage = string.Empty;
        _attachedImageDataUrl = null;

        // Show typing indicator
        _isTyping = true;
        StateHasChanged();

        // Get reply from engine
        var reply = await ReplyEngine.GetReplyAsync(_selectedAgent, messageText, hasImage);

        // Hide typing indicator
        _isTyping = false;

        // Add agent message
        var agentMessage = new ChatMessage
        {
            Role = "Agent",
            Text = reply,
            Timestamp = DateTime.Now,
            AgentName = _selectedAgent
        };
        _messages.Add(agentMessage);

        StateHasChanged();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private void ShowImageModal(string? imageUrl)
    {
        _modalImageUrl = imageUrl;
    }

    private void CloseImageModal()
    {
        _modalImageUrl = null;
    }
}
